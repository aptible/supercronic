sudo: false
dist: trusty

language: go

go: "1.14.4"

install:
  - make deps
  - git clone https://github.com/sstephenson/bats.git --branch v0.4.0 --depth 1 "${HOME}/bats"
  - export "PATH=${PATH}:${HOME}/bats/bin"

jobs:
  include:
    - stage: test
      script:
        - make fmt
        - git diff --exit-code ':(exclude)go.sum'
        - make test
    - stage: build
      script:
        - mkdir -p dist
        - export GOOS="linux"
        - export CGO_ENABLED=0
        - for arch in amd64 386 arm arm64; do GOARCH="$arch" go build && file supercronic | grep 'statically linked' && mv supercronic "dist/supercronic-${GOOS}-${arch}"; done
        - pushd dist
        - ls -lah *
        - file *
        - sha1sum *
        - sha256sum *
        - popd
      deploy:
        provider: releases
        api_key:
          secure: "JkMFjH37yPTU+ptgMhvKlGqKcunQ61ijeWRjjgjzckx/3n0OM/8o/FSgUOUKC2IQpvPAdQ+VyQZ6aUV7Tu4bv8GyV+PclAAbQWxRNGceGKegUqQpFphNRf4SegpJExf7oDq8I4Hx68hAC1lH5tsDkhJrTZyaAWlWSs9njS7kceSZowJJn8KVOlfVyme3j1dWsMDnx7ss8XD9wouNru0RwwsBULJLFsWuokOn1bWwY3eak2lWFz1RowDciULtsf/8enDcppiOFlfl2mjWuIjpZvVqz594uwLeWxZSD+D62XJT1U6t9/dTHa0xnZPnefJdZKytkwCzZjmDzSob8qFHf8iho2OK4Nd44ruXrITXBMfu+QuOQ46iDmvmbiIZSZwMU0MfjF6eyrEIDjpmHIUAlD3UaqPajJIJ3oH423/j15ZeiwIXArYio3vWB/g1WZhHrfNbLXDvxlOZ4KtSy8uqHQ60tp6cO7yjzi3rmjMI78576q1oLC1Ay/KWnVLeJAbI84nt47vIc9wodbauMAIKiAa1h0wjNZNb9Puyd8c+Y0+RF+nCSK51THTIoVPYKjwHMs2jaqawkD7UY9rbwlrc/OvN8lrcmpTAcl/GUnqYl1RaWhKKKJxd117fbH3Izm68i2M15Ht7zjQ0dfnOowjYyHD52PXe+qenooT3Mq1is9U="
        file: "dist/*"
        file_glob: true
        skip_cleanup: true
        on:
          tags: true
